<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `/home/runner/work/SW8S-Rust/SW8S-Rust/target/debug/build/sw8s_rust-3abdc18a8af83988/out/graph_missions/graph.rs`."><title>graph.rs - source</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../../../../../../../../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../../../../../../../../../../static.files/rustdoc-dd39b87e5fcfba68.css"><meta name="rustdoc-vars" data-root-path="../../../../../../../../../../../../../" data-static-root-path="../../../../../../../../../../../../../static.files/" data-current-crate="sw8s_rust_graphs" data-themes="" data-resource-suffix="" data-rustdoc-version="1.80.0 (051478957 2024-07-21)" data-channel="1.80.0" data-search-js="search-d52510db62a78183.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../../../../../../../../../../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../../../../../../../../../../../../../static.files/src-script-e66d777a5a92e9b2.js"></script><script defer src="../../../../../../../../../../../../../src-files.js"></script><script defer src="../../../../../../../../../../../../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../../../../../../../../../../../../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../../../../../../../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../../../../../../../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc src"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="src-sidebar-title"><h2>Files</h2></div></nav><div class="sidebar-resizer"></div><main><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><a href="#1" id="1">1</a>
</pre></div><pre class="rust"><code><span class="kw">use </span>sw8s_rust_lib :: missions :: action :: Action <span class="kw">as </span>GraphAction ; <span class="kw">use </span>sw8s_rust_lib :: missions :: action :: ActionExec <span class="kw">as </span>GraphActionExec ; <span class="kw">use </span>sw8s_rust_lib :: missions :: action_context <span class="kw">as </span>GraphActionContext ; <span class="kw">use </span>itertools :: Itertools ; <span class="kw">use </span>std :: any :: type_name ; <span class="kw">use </span>uuid :: Uuid ; # [cfg (feature = <span class="string">"graphing"</span>)] <span class="kw">use </span>graphviz_rust :: { cmd :: Format , exec , parse , printer :: PrinterContext } ; <span class="kw">use </span>sw8s_rust_lib :: missions :: action :: Action ; <span class="kw">pub fn </span>stripped_type &lt; T : <span class="question-mark">? </span>Sized &gt; () -&gt; &amp; <span class="lifetime">'static </span>str { <span class="kw">let </span>raw = type_name :: &lt; T &gt; () ; strip_sig (raw) } <span class="kw">pub fn </span>stripped_fn &lt; T : <span class="question-mark">? </span>Sized &gt; () -&gt; String { <span class="kw">let </span>raw = type_name :: &lt; T &gt; () ; <span class="kw">if </span>raw . ends_with (<span class="string">"{{closure}}"</span>) { <span class="string">"Anon Closure" </span>. to_string () } <span class="kw">else </span>{ <span class="kw">let </span>(fn_sig , output) = raw . split (<span class="string">"-&gt;"</span>) . collect_tuple () . unwrap_or ((raw , <span class="string">"?"</span>)) ; <span class="kw">let </span>(fn_first , fn_mid , fn_end) = fn_sig . split ([<span class="string">'(' </span>, <span class="string">')'</span>]) . collect_tuple () . unwrap () ; fn_first . to_string () + <span class="string">"(" </span>+ strip_sig (fn_mid) + <span class="string">")" </span>+ fn_end + <span class="string">"-&gt;" </span>+ strip_sig (output) } } <span class="kw">fn </span>strip_sig (<span class="kw-2">mut </span>raw : &amp; str) -&gt; &amp; str { <span class="kw">if let </span><span class="prelude-val">Some </span>(idx) = raw . find (<span class="string">'&lt;'</span>) { raw = &amp; raw [<span class="number">0 </span>.. idx] ; } <span class="kw">if let </span><span class="prelude-val">Some </span>(idx) = raw . rfind (<span class="string">':'</span>) { raw = &amp; raw [idx + <span class="number">1 </span>..] ; } raw } # [doc = <span class="string">" Contains information for dot (graphviz) graphing"</span>] # [derive (Debug , Clone)] <span class="kw">pub struct </span>DotString { <span class="kw">pub </span>head_ids : Vec &lt; Uuid &gt; , <span class="kw">pub </span>tail_ids : Vec &lt; Uuid &gt; , <span class="kw">pub </span>body : String , } <span class="kw">impl </span>DotString { <span class="kw">pub fn </span>prepend (&amp; <span class="kw-2">mut </span><span class="self">self </span>, other : &amp; <span class="self">Self</span>) { <span class="self">self </span>. body = other . body . clone () + <span class="string">"\n" </span>+ &amp; <span class="self">self </span>. body ; } <span class="kw">pub fn </span>append (&amp; <span class="kw-2">mut </span><span class="self">self </span>, other : &amp; <span class="self">Self</span>) { <span class="self">self </span>. body . push (<span class="string">'\n'</span>) ; <span class="self">self </span>. body . push_str (&amp; other . body) ; } } # [doc = <span class="string">" Generate the .dot (graphviz) file to draw the action"</span>] <span class="kw">pub fn </span>dot_file &lt; T : <span class="question-mark">? </span>Sized + Action &gt; (act : &amp; T) -&gt; String { <span class="kw">let </span>header = <span class="string">"digraph G {\nsplines = true;\nnodesep = 1.0;\nbgcolor = \"none\"\n" </span>. to_string () ; <span class="kw">let </span>full = header + &amp; act . dot_string (<span class="string">""</span>) . body + <span class="string">"}" </span>; indent_lines (reorder_dot_strings (&amp; full . split (<span class="string">'\n'</span>) . collect_vec ()) . lines ()) } # [doc = <span class="string">" Reorders the generated dot strings to render better"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" For some reason the layout engine does better with labels declared after"</span>] # [doc = <span class="string">" lines, see &lt;https://stackoverflow.com/a/9238952&gt;."</span>] # [doc = <span class="string">" This function reorders each graph and subgraph in the order of header, metadata, subgraphs,"</span>] # [doc = <span class="string">" edges, and then labels."</span>] <span class="kw">fn </span>reorder_dot_strings (arr : &amp; [&amp; str]) -&gt; String { <span class="kw">let </span><span class="kw-2">mut </span>labels = vec ! [] ; <span class="kw">let </span><span class="kw-2">mut </span>graphs = vec ! [] ; <span class="kw">let </span><span class="kw-2">mut </span>edges = vec ! [] ; <span class="kw">let </span><span class="kw-2">mut </span>meta = vec ! [] ; <span class="kw">let </span>header = arr . first () . unwrap () . to_string () ; <span class="kw">let </span><span class="kw-2">mut </span>pos = <span class="number">1 </span>; <span class="kw">while </span>pos &lt; arr . len () { <span class="kw">let </span>val = arr [pos] ; pos += <span class="number">1 </span>; <span class="kw">if </span>val . starts_with (<span class="string">'}'</span>) { <span class="kw">break </span>; } ; <span class="kw">if </span>val . starts_with (<span class="string">"subgraph"</span>) { <span class="kw">let </span>subgraph = reorder_dot_strings (&amp; arr [(pos - <span class="number">1</span>) ..]) ; pos += subgraph . split (<span class="string">'\n'</span>) . filter (| line | ! line . starts_with (<span class="string">'}'</span>)) . count () - <span class="number">1 </span>; graphs . push (subgraph) ; <span class="kw">continue </span>; } ; <span class="kw">if let </span><span class="prelude-val">Some </span>(stripped_val) = val . strip_prefix (<span class="string">'"'</span>) { <span class="kw">if let </span><span class="prelude-val">Some </span>(end_quote) = stripped_val . find (<span class="string">'"'</span>) { <span class="kw">let </span>end_pos = end_quote + <span class="number">1 </span>; <span class="kw">if </span>&amp; val [end_pos + <span class="number">1 </span>.. end_pos + <span class="number">8</span>] == <span class="string">" [label" </span>{ labels . push (val) ; <span class="kw">continue </span>; } } } <span class="kw">if </span>val . contains (<span class="string">"-&gt;"</span>) { edges . push (val) ; <span class="kw">continue </span>; } meta . push (val) ; } [vec ! [header] , meta . into_iter () . map (| x | x . to_string ()) . collect () , graphs , edges . into_iter () . map (| x | x . to_string ()) . collect () , labels . into_iter () . map (| x | x . to_string ()) . collect () , vec ! [<span class="string">"}" </span>. to_string ()] ,] . into_iter () . flatten () . fold (String :: new () , | acc , line | (acc + &amp; line + <span class="string">"\n"</span>)) } # [doc = <span class="string">" Indents blocks inside the .dot (graphviz) file"</span>] <span class="kw">fn </span>indent_lines &lt; I , T &gt; (iter : I) -&gt; String <span class="kw">where </span>I : IntoIterator &lt; Item = T &gt; , T : AsRef &lt; str &gt; , { <span class="kw">let </span><span class="kw-2">mut </span>num_tabs = <span class="number">0 </span>; iter . into_iter () . map (| line | { <span class="kw">let </span><span class="kw-2">mut </span>line = line . as_ref () . to_string () ; <span class="kw">if </span>line . trim () . starts_with (<span class="string">'}'</span>) { num_tabs -= <span class="number">1 </span>; } <span class="kw">for _ in </span><span class="number">0 </span>.. num_tabs { line = <span class="string">"\t" </span>. to_string () + &amp; line ; } <span class="kw">if </span>line . ends_with (<span class="string">'{'</span>) { num_tabs += <span class="number">1 </span>; } line }) . fold (String :: new () , | acc , line | (acc + &amp; line + <span class="string">"\n"</span>)) } # [cfg (feature = <span class="string">"graphing"</span>)] <span class="kw">pub fn </span>draw_svg &lt; T : <span class="question-mark">? </span>Sized + Action &gt; (act : &amp; T) -&gt; std :: io :: <span class="prelude-ty">Result </span>&lt; Vec &lt; u8 &gt; &gt; { exec (parse (&amp; dot_file (act)) . unwrap () , &amp; <span class="kw-2">mut </span>PrinterContext :: default () , vec ! [Format :: Svg . into ()] ,) } <span class="kw">pub fn </span>graph_actions&lt;T: GraphActionContext::GetMainElectronicsBoard + GraphActionContext::GetControlBoard&lt;tokio::io::WriteHalf&lt;tokio_serial::SerialStream&gt;&gt; + GraphActionContext::GetFrontCamMat + Send + Sync + std::marker::Unpin&gt;(context: <span class="kw-2">&amp;</span>T) -&gt; Vec&lt;(String, Box&lt;<span class="kw">dyn </span>GraphAction + <span class="lifetime">'_</span>&gt;)&gt; { <span class="macro">vec!</span>[]}</code></pre></div></section></main></body></html>