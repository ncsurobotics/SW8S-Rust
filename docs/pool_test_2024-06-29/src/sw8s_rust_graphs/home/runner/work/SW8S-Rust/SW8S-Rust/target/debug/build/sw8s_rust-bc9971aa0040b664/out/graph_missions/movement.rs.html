<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `/home/runner/work/SW8S-Rust/SW8S-Rust/target/debug/build/sw8s_rust-bc9971aa0040b664/out/graph_missions/movement.rs`."><title>movement.rs - source</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../../../../../../../../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../../../../../../../../../../static.files/rustdoc-081576b923113409.css"><meta name="rustdoc-vars" data-root-path="../../../../../../../../../../../../../" data-static-root-path="../../../../../../../../../../../../../static.files/" data-current-crate="sw8s_rust_graphs" data-themes="" data-resource-suffix="" data-rustdoc-version="1.79.0 (129f3b996 2024-06-10)" data-channel="1.79.0" data-search-js="search-bf21c90c8c1d92b1.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../../../../../../../../../../../static.files/storage-e32f0c247825364d.js"></script><script defer src="../../../../../../../../../../../../../static.files/src-script-e66d777a5a92e9b2.js"></script><script defer src="../../../../../../../../../../../../../src-files.js"></script><script defer src="../../../../../../../../../../../../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../../../../../../../../../../../../static.files/noscript-09095024cf37855e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../../../../../../../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../../../../../../../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc src"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="src-sidebar-title"><h2>Files</h2></div></nav><div class="sidebar-resizer"></div><main><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../../../../../../../../../../../../../sw8s_rust_graphs/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Type ‘S’ or ‘/’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../../../../../../../../../../../../../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../../../../../../../../../../../settings.html" title="settings">Settings</a></div></form></nav><section id="main-content" class="content"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><a href="#1" id="1">1</a>
</pre></div><pre class="rust"><code><span class="kw">use </span>sw8s_rust_lib :: missions :: action :: Action <span class="kw">as </span>GraphAction ; <span class="kw">use </span>sw8s_rust_lib :: missions :: action :: ActionExec <span class="kw">as </span>GraphActionExec ; <span class="kw">use </span>sw8s_rust_lib :: missions :: action_context <span class="kw">as </span>GraphActionContext ; <span class="kw">use </span>sw8s_rust_lib :: comms :: control_board :: ControlBoard ; <span class="kw">use </span>sw8s_rust_lib :: vision :: DrawRect2d ; <span class="kw">use </span>sw8s_rust_lib :: vision :: Offset2D ; <span class="kw">use </span>sw8s_rust_lib :: vision :: RelPos ; <span class="kw">use </span>sw8s_rust_lib :: vision :: RelPosAngle ; <span class="kw">use </span>anyhow :: <span class="prelude-ty">Result </span>; <span class="kw">use </span>core :: fmt :: Debug ; <span class="kw">use </span>derive_getters :: Getters ; <span class="kw">use </span>num_traits :: abs ; <span class="kw">use </span>num_traits :: clamp ; <span class="kw">use </span>num_traits :: Pow ; <span class="kw">use </span>num_traits :: Zero ; <span class="kw">use </span>std :: marker :: PhantomData ; <span class="kw">use </span>std :: ops :: Rem ; <span class="kw">use </span>std :: time :: Duration ; <span class="kw">use </span>tokio :: time :: sleep ; <span class="kw">use </span>tokio :: io :: WriteHalf ; <span class="kw">use </span>tokio_serial :: SerialStream ; <span class="kw">use </span>sw8s_rust_lib :: missions :: { action :: { Action , ActionExec , ActionMod } , action_context :: GetControlBoard , } ; # [derive (Debug)] <span class="kw">pub struct </span>Descend &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , target_depth : f32 , } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; Descend &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub const fn </span>new (context : &amp; <span class="lifetime">'a </span>T , target_depth : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth , } } <span class="kw">pub const fn </span>uninitialized (context : &amp; <span class="lifetime">'a </span>T) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth : <span class="number">0.0 </span>, } } } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>Descend &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; f32 &gt; <span class="kw">for </span>Descend &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; f32) { <span class="self">self </span>. target_depth = * input ; } } <span class="kw">impl </span>&lt; T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>Descend &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { println ! (<span class="string">"DESCEND"</span>) ; <span class="self">self </span>. context . get_control_board () . stability_2_speed_set_initial_yaw (<span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="self">self </span>. target_depth) . <span class="kw">await </span><span class="question-mark">? </span>; println ! (<span class="string">"GOT SPEED SET"</span>) ; <span class="prelude-val">Ok </span>(()) } } # [derive (Debug)] <span class="kw">pub struct </span>StraightMovement &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , target_depth : f32 , forward : bool , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>StraightMovement &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; StraightMovement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub const fn </span>new (context : &amp; <span class="lifetime">'a </span>T , target_depth : f32 , forward : bool) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth , forward , } } <span class="kw">pub const fn </span>uninitialized (context : &amp; <span class="lifetime">'a </span>T) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth : <span class="number">0.0 </span>, forward : <span class="bool-val">false </span>, } } } <span class="kw">impl </span>&lt; T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>StraightMovement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="kw">let </span><span class="kw-2">mut </span>speed : f32 = <span class="number">0.3 </span>; <span class="kw">if </span>! <span class="self">self </span>. forward { speed = - speed ; } <span class="self">self </span>. context . get_control_board () . stability_2_speed_set_initial_yaw (<span class="number">0.0 </span>, speed , <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="self">self </span>. target_depth) . <span class="kw">await </span>} } # [derive (Debug)] <span class="kw">pub struct </span>ZeroMovement &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , target_depth : f32 , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>ZeroMovement &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; ZeroMovement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub fn </span>new (context : &amp; <span class="lifetime">'a </span>T , target_depth : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth , } } } <span class="kw">impl </span>&lt; T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>ZeroMovement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="self">self </span>. context . get_control_board () . stability_2_speed_set_initial_yaw (<span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="self">self </span>. target_depth) . <span class="kw">await </span>} } # [derive (Debug)] <span class="kw">pub struct </span>AdjustMovement &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , x : f32 , target_depth : f32 , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>AdjustMovement &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; AdjustMovement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub fn </span>new (context : &amp; <span class="lifetime">'a </span>T , target_depth : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth , x : <span class="number">0.0 </span>, } } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; f32 &gt; <span class="kw">for </span>AdjustMovement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; f32) { <span class="self">self </span>. target_depth = * input ; } } <span class="kw">impl </span>&lt; T , V &gt; ActionMod &lt; <span class="prelude-ty">Result </span>&lt; V &gt; &gt; <span class="kw">for </span>AdjustMovement &lt; <span class="lifetime">'_ </span>, T &gt; <span class="kw">where </span>V : RelPos &lt; Number = f64 &gt; + Sync + Send + Debug , { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; <span class="prelude-ty">Result </span>&lt; V &gt;) { <span class="kw">if let </span><span class="prelude-val">Ok </span>(input) = input { println ! (<span class="string">"Modify value: {:#?}" </span>, input) ; <span class="kw">if </span>! input . offset () . x () . is_nan () || ! input . offset () . y () . is_nan () { <span class="self">self </span>. x = * input . offset () . x () <span class="kw">as </span>f32 ; } <span class="kw">else </span>{ <span class="self">self </span>. x = <span class="number">0.0 </span>; } } <span class="kw">else </span>{ <span class="self">self </span>. x = <span class="number">0.0 </span>; } } } <span class="kw">impl </span>&lt; T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>AdjustMovement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="self">self </span>. context . get_control_board () . stability_2_speed_set_initial_yaw (<span class="self">self </span>. x , <span class="number">0.5 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="self">self </span>. target_depth) . <span class="kw">await </span>} } # [derive (Debug)] <span class="kw">pub struct </span>AdjustMovementAngle &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , x : f32 , yaw_adjust : f32 , target_depth : f32 , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>AdjustMovementAngle &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; AdjustMovementAngle &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub fn </span>new (context : &amp; <span class="lifetime">'a </span>T , target_depth : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth , x : <span class="number">0.0 </span>, yaw_adjust : <span class="number">0.0 </span>, } } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; f32 &gt; <span class="kw">for </span>AdjustMovementAngle &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; f32) { <span class="self">self </span>. target_depth = * input ; } } <span class="kw">impl </span>&lt; T , V &gt; ActionMod &lt; <span class="prelude-ty">Result </span>&lt; V &gt; &gt; <span class="kw">for </span>AdjustMovementAngle &lt; <span class="lifetime">'_ </span>, T &gt; <span class="kw">where </span>V : RelPos &lt; Number = f64 &gt; + Sync + Send + Debug , { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; <span class="prelude-ty">Result </span>&lt; V &gt;) { <span class="kw">const </span>MIN_TO_CHANGE_ANGLE : f32 = <span class="number">0.1 </span>; <span class="kw">const </span>ANGLE_DIFF : f32 = <span class="number">20.0 </span>; <span class="kw">if let </span><span class="prelude-val">Ok </span>(input) = input { println ! (<span class="string">"Modify value: {:#?}" </span>, input) ; <span class="kw">if </span>! input . offset () . x () . is_nan () &amp;&amp; ! input . offset () . y () . is_nan () { <span class="self">self </span>. x = * input . offset () . x () <span class="kw">as </span>f32 ; <span class="self">self </span>. yaw_adjust += <span class="kw">if </span><span class="self">self </span>. x . abs () &gt; MIN_TO_CHANGE_ANGLE { <span class="self">self </span>. x * ANGLE_DIFF } <span class="kw">else </span>{ <span class="number">0.0 </span>} ; println ! (<span class="string">"YAW ADJUST: {}" </span>, <span class="self">self </span>. yaw_adjust) ; } <span class="kw">else </span>{ <span class="self">self </span>. x = <span class="number">0.0 </span>; } } <span class="kw">else </span>{ <span class="self">self </span>. x = <span class="number">0.0 </span>; } } } <span class="kw">impl </span>&lt; T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>AdjustMovementAngle &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="kw">const </span>ADJUST_VAL : f32 = <span class="number">1.5 </span>; <span class="kw">const </span>MIN_X : f32 = <span class="number">0.3 </span>; <span class="kw">let </span>yaw = <span class="kw">if let </span><span class="prelude-val">Some </span>(angles) = <span class="self">self </span>. context . get_control_board () . get_initial_angles () . <span class="kw">await </span>{ println ! (<span class="string">"Initial Yaw: {}" </span>, angles . yaw ()) ; <span class="kw">let </span><span class="kw-2">mut </span>inner_yaw = angles . yaw () + <span class="self">self </span>. yaw_adjust ; <span class="kw">if </span>inner_yaw . abs () &gt; <span class="number">180.0 </span>{ <span class="kw">let </span>sign = inner_yaw / inner_yaw . abs () ; inner_yaw = - (inner_yaw - (sign * <span class="number">180.0</span>)) ; } inner_yaw } <span class="kw">else </span>{ <span class="number">0.0 </span>} ; println ! (<span class="string">"Current Yaw: {:#?}" </span>, <span class="self">self </span>. context . get_control_board () . responses () . get_angles () . <span class="kw">await </span>. map (| angles | * angles . yaw ())) ; println ! (<span class="string">"Adjusted Yaw: {}" </span>, yaw) ; println ! (<span class="string">"Prior x: {}" </span>, <span class="self">self </span>. x) ; <span class="kw">let </span><span class="kw-2">mut </span>x = <span class="self">self </span>. x . signum () * <span class="self">self </span>. x . abs () . pow (ADJUST_VAL) ; <span class="kw">if </span>x . abs () &lt; MIN_X { x = <span class="number">0.0 </span>; } println ! (<span class="string">"Setting x to {x}"</span>) ; <span class="self">self </span>. context . get_control_board () . stability_2_speed_set (x , <span class="number">0.5 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, yaw , <span class="self">self </span>. target_depth) . <span class="kw">await </span>} } # [derive (Debug)] <span class="kw">pub struct </span>CenterMovement &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , x : f32 , y : f32 , yaw : f32 , target_depth : f32 , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>CenterMovement &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; CenterMovement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub fn </span>new (context : &amp; <span class="lifetime">'a </span>T , target_depth : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , target_depth , x : <span class="number">0.0 </span>, y : <span class="number">0.0 </span>, yaw : <span class="number">0.0 </span>, } } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; f32 &gt; <span class="kw">for </span>CenterMovement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; f32) { <span class="self">self </span>. target_depth = * input ; } } <span class="kw">impl </span>&lt; T , V &gt; ActionMod &lt; <span class="prelude-ty">Result </span>&lt; V &gt; &gt; <span class="kw">for </span>CenterMovement &lt; <span class="lifetime">'_ </span>, T &gt; <span class="kw">where </span>V : RelPosAngle &lt; Number = f64 &gt; + Sync + Send + Debug , { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; <span class="prelude-ty">Result </span>&lt; V &gt;) { <span class="kw">if let </span><span class="prelude-val">Ok </span>(input) = input { println ! (<span class="string">"Modify value: {:#?}" </span>, input) ; <span class="kw">if </span>! input . offset () . x () . is_nan () &amp;&amp; ! input . offset () . y () . is_nan () { <span class="self">self </span>. x = * input . offset () . x () <span class="kw">as </span>f32 ; <span class="self">self </span>. y = * input . offset () . y () <span class="kw">as </span>f32 ; <span class="self">self </span>. yaw = * input . offset_angle () . angle () <span class="kw">as </span>f32 ; } <span class="kw">else </span>{ <span class="self">self </span>. x = <span class="number">0.0 </span>; <span class="self">self </span>. y = <span class="number">0.0 </span>; } } <span class="kw">else </span>{ <span class="self">self </span>. x = <span class="number">0.0 </span>; <span class="self">self </span>. y = <span class="number">0.0 </span>; } } } <span class="kw">impl </span>&lt; T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>CenterMovement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="kw">const </span>FACTOR : f32 = <span class="number">1.5 </span>; <span class="kw">const </span>MIN_SPEED : f32 = <span class="number">0.3 </span>; # [allow (dead_code)] <span class="kw">const </span>MIN_YAW : f32 = <span class="number">5.0 </span>; <span class="kw">let </span><span class="kw-2">mut </span>x = <span class="self">self </span>. x . pow (FACTOR) ; <span class="kw">let </span><span class="kw-2">mut </span>y = <span class="self">self </span>. y . pow (FACTOR) ; <span class="kw">let </span>yaw = <span class="self">self </span>. yaw ; <span class="kw">if </span>x &lt; MIN_SPEED { x = <span class="number">0.0 </span>; } <span class="kw">if </span>y &lt; MIN_SPEED { y = <span class="number">0.0 </span>; } <span class="self">self </span>. context . get_control_board () . stability_2_speed_set (x , y , <span class="number">0.0 </span>, <span class="number">0.0 </span>, yaw , <span class="self">self </span>. target_depth) . <span class="kw">await </span>} } # [doc = <span class="string">" Specifies replacement or adjustment (+ value)"</span>] # [derive (Debug , Clone)] <span class="kw">pub enum </span>AdjustType &lt; T &gt; { Replace (T) , Adjust (T) , } # [doc = <span class="string">" Modification for a stability assist 2 command"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" When values are None, they do not cause adjustments"</span>] # [derive (Debug , Clone , Default , Getters)] <span class="kw">pub struct </span>Stability2Adjust { x : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , y : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_pitch : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_roll : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_yaw : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_depth : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , } <span class="kw">impl </span>Stability2Adjust { <span class="kw">pub const fn </span>const_default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ x : <span class="prelude-val">None </span>, y : <span class="prelude-val">None </span>, target_pitch : <span class="prelude-val">None </span>, target_roll : <span class="prelude-val">None </span>, target_yaw : <span class="prelude-val">None </span>, target_depth : <span class="prelude-val">None </span>, } } # [doc = <span class="string">" Convert all the invalid IEEE states into None"</span>] <span class="kw">fn </span>address_ieee (val : AdjustType &lt; f32 &gt;) -&gt; <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; { <span class="kw">match </span>val { AdjustType :: Replace (val) | AdjustType :: Adjust (val) <span class="kw">if </span>val . is_nan () | val . is_infinite () | val . is_subnormal () =&gt; { <span class="prelude-val">None </span>} val =&gt; <span class="prelude-val">Some </span>(val) , } } # [doc = <span class="string">" Bounds speeds to [-1, 1]"</span>] <span class="kw">fn </span>bound_speed (val : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; { <span class="kw">const </span>MIN_SPEED : f32 = - <span class="number">1.0 </span>; <span class="kw">const </span>MAX_SPEED : f32 = <span class="number">1.0 </span>; val . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; AdjustType :: Replace (clamp (val , MIN_SPEED , MAX_SPEED)) , AdjustType :: Adjust (val) =&gt; AdjustType :: Adjust (val) , }) } # [doc = <span class="string">" Bounds rotations to 360 degrees"</span>] <span class="kw">fn </span>bound_rot (val : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; { <span class="kw">const </span>MAX_DEGREES : f32 = <span class="number">360.0 </span>; val . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; AdjustType :: Replace (val . rem (MAX_DEGREES)) , AdjustType :: Adjust (val) =&gt; AdjustType :: Adjust (val) , }) } <span class="kw">pub fn </span>set_x (&amp; <span class="kw-2">mut </span><span class="self">self </span>, x : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. x = <span class="self">Self </span>:: bound_speed (<span class="self">Self </span>:: address_ieee (x)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_y (&amp; <span class="kw-2">mut </span><span class="self">self </span>, y : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. y = <span class="self">Self </span>:: bound_speed (<span class="self">Self </span>:: address_ieee (y)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_pitch (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_pitch : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_pitch = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_pitch)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_roll (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_roll : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_roll = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_roll)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_yaw (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_yaw : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_yaw = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_yaw)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_depth (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_depth : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_depth = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_depth)) ; <span class="self">self </span>} } # [doc = <span class="string">" Stores the command to send to stability assist 2"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" If target_yaw is None, it is set to the current yaw on first execution"</span>] # [derive (Debug , Clone)] <span class="kw">pub struct </span>Stability2Pos { x : f32 , y : f32 , target_pitch : f32 , target_roll : f32 , target_yaw : <span class="prelude-ty">Option </span>&lt; f32 &gt; , target_depth : f32 , } <span class="kw">impl </span>Stability2Pos { <span class="kw">pub const fn </span>new (x : f32 , y : f32 , target_pitch : f32 , target_roll : f32 , target_yaw : <span class="prelude-ty">Option </span>&lt; f32 &gt; , target_depth : f32 ,) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ x , y , target_pitch , target_roll , target_yaw , target_depth , } } # [doc = <span class="string">" Executes the position in stability assist"</span>] <span class="kw">pub async fn </span>exec (&amp; <span class="kw-2">mut </span><span class="self">self </span>, board : &amp; ControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt;) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="kw">const </span>SLEEP_LEN : Duration = Duration :: from_millis (<span class="number">100</span>) ; <span class="kw">if </span><span class="self">self </span>. target_yaw . is_none () { <span class="kw">loop </span>{ <span class="kw">if let </span><span class="prelude-val">Some </span>(angles) = board . responses () . get_angles () . <span class="kw">await </span>{ <span class="self">self </span>. target_yaw = <span class="prelude-val">Some </span>(* angles . yaw ()) ; <span class="kw">break </span>; } sleep (SLEEP_LEN) . <span class="kw">await </span>; } } println ! (<span class="string">"Stability 2 speed set: {:#?}" </span>, <span class="self">self</span>) ; board . stability_2_speed_set (<span class="self">self </span>. x , <span class="self">self </span>. y , <span class="self">self </span>. target_pitch , <span class="self">self </span>. target_roll , <span class="self">self </span>. target_yaw . unwrap () , <span class="self">self </span>. target_depth ,) . <span class="kw">await </span>} # [doc = <span class="string">" Sets speed, bounded to [-1, 1]"</span>] <span class="kw">fn </span>set_speed (base : f32 , adjuster : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; f32 { <span class="kw">const </span>MIN_SPEED : f32 = - <span class="number">1.0 </span>; <span class="kw">const </span>MAX_SPEED : f32 = <span class="number">1.0 </span>; adjuster . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; val , AdjustType :: Adjust (val) =&gt; clamp (base + val , MIN_SPEED , MAX_SPEED) , }) . unwrap_or (base) } # [doc = <span class="string">" Set rotation, bounded to 360 degrees"</span>] <span class="kw">fn </span>set_rot (base : f32 , adjuster : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; f32 { <span class="kw">const </span>MAX_DEGREES : f32 = <span class="number">360.0 </span>; adjuster . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; val , AdjustType :: Adjust (val) =&gt; (val + base) . rem (MAX_DEGREES) , }) . unwrap_or (base) } # [doc = <span class="string">" Adjusts the position according to `adjuster`."</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" The x and y fields are bounded to [-1, 1]."</span>] # [doc = <span class="string">" The pitch, roll, yaw, depth fields wrap around 360 degrees."</span>] <span class="kw">pub fn </span>adjust (&amp; <span class="kw-2">mut </span><span class="self">self </span>, adjuster : &amp; Stability2Adjust) -&gt; &amp; <span class="self">Self </span>{ println ! (<span class="string">"Stability 2 pre-adjust: {:#?}" </span>, <span class="self">self</span>) ; println ! (<span class="string">"Adjuster: {:#?}" </span>, adjuster) ; <span class="self">self </span>. x = <span class="self">Self </span>:: set_speed (<span class="self">self </span>. x , adjuster . x () . clone ()) ; <span class="self">self </span>. y = <span class="self">Self </span>:: set_speed (<span class="self">self </span>. y , adjuster . y () . clone ()) ; <span class="self">self </span>. target_pitch = <span class="self">Self </span>:: set_rot (<span class="self">self </span>. target_pitch , adjuster . target_pitch () . clone ()) ; <span class="self">self </span>. target_roll = <span class="self">Self </span>:: set_rot (<span class="self">self </span>. target_roll , adjuster . target_roll () . clone ()) ; <span class="self">self </span>. target_depth = <span class="self">Self </span>:: set_rot (<span class="self">self </span>. target_depth , adjuster . target_depth () . clone ()) ; <span class="self">self </span>. target_yaw = <span class="kw">if let </span><span class="prelude-val">Some </span>(target_yaw) = <span class="self">self </span>. target_yaw { <span class="prelude-val">Some </span>(<span class="self">Self </span>:: set_rot (target_yaw , adjuster . target_yaw () . clone ())) } <span class="kw">else if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (adjuster_yaw)) = adjuster . target_yaw () { <span class="prelude-val">Some </span>(* adjuster_yaw) } <span class="kw">else </span>{ <span class="prelude-val">None </span>} ; println ! (<span class="string">"Stability 2 post-adjust: {:#?}" </span>, <span class="self">self</span>) ; <span class="self">self </span>} <span class="kw">pub const fn </span>const_default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new (<span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="prelude-val">None </span>, <span class="number">0.0</span>) } } <span class="kw">impl </span>Default <span class="kw">for </span>Stability2Pos { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: const_default () } } # [derive (Debug)] <span class="kw">pub struct </span>Stability2Movement &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , pose : Stability2Pos , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>Stability2Movement &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; Stability2Movement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub const fn </span>new (context : &amp; <span class="lifetime">'a </span>T , pose : Stability2Pos) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , pose } } <span class="kw">pub fn </span>uninitialized (context : &amp; <span class="lifetime">'a </span>T) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , pose : Stability2Pos :: default () , } } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; Stability2Pos &gt; <span class="kw">for </span>Stability2Movement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; Stability2Pos) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; Stability2Adjust &gt; <span class="kw">for </span>Stability2Movement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; Stability2Adjust) { <span class="self">self </span>. pose . adjust (input) ; } } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>Stability2Movement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="self">self </span>. pose . exec (<span class="self">self </span>. context . get_control_board ()) . <span class="kw">await </span>} } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; () &gt; <span class="kw">for </span>Stability2Movement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) { <span class="kw">let _ </span>= <span class="self">self </span>. pose . exec (<span class="self">self </span>. context . get_control_board ()) . <span class="kw">await </span>; } } # [doc = <span class="string">" Generates a yaw adjustment from an x axis set, multiplying by angle_diff"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" Does not set a yaw adjustment if the x difference is below 0.1"</span>] <span class="kw">pub fn </span>linear_yaw_from_x (<span class="kw-2">mut </span>input : Stability2Adjust , angle_diff : f32) -&gt; Stability2Adjust { <span class="kw">const </span>MIN_TO_CHANGE_ANGLE : f32 = <span class="number">0.1 </span>; <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (x)) = input . x () { <span class="kw">if </span>abs (* x) &gt; MIN_TO_CHANGE_ANGLE { input . set_target_yaw (AdjustType :: Adjust (- x * angle_diff)) ; } ; } ; input } # [doc = <span class="string">" Generates a yaw adjustment from an x axis set, multiplying by angle_diff"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" Does not set a yaw adjustment if the x difference is below 0.1"</span>] <span class="kw">pub fn </span>linear_yaw_from_x_stab1 (<span class="kw-2">mut </span>input : Stability1Adjust , angle_diff : f32) -&gt; Stability1Adjust { <span class="kw">const </span>MIN_TO_CHANGE_ANGLE : f32 = <span class="number">0.1 </span>; <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (x)) = input . x () { <span class="kw">if </span>abs (* x) &gt; MIN_TO_CHANGE_ANGLE { input . set_yaw_speed (AdjustType :: Adjust (- x * angle_diff)) ; } ; } ; input } <span class="kw">pub fn </span>aggressive_yaw_from_x (<span class="kw-2">mut </span>input : Stability2Adjust , angle_diff : f32) -&gt; Stability2Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (x)) = input . x () { <span class="kw">if </span>! x . is_zero () { input . set_target_yaw (AdjustType :: Adjust (x . signum () * angle_diff)) ; } ; } ; input } # [doc = <span class="string">" [`linear_yaw_from_x`] with a default value"</span>] <span class="kw">pub const fn </span>default_linear_yaw_from_x () -&gt; <span class="kw">fn </span>(Stability2Adjust) -&gt; Stability2Adjust { <span class="kw">const </span>ANGLE_DIFF : f32 = <span class="number">7.0 </span>; | input | linear_yaw_from_x (input , ANGLE_DIFF) } # [doc = <span class="string">" Action version of [`linear_yaw_from_x`]"</span>] # [derive (Debug)] <span class="kw">pub struct </span>LinearYawFromX &lt; T &gt; { angle_diff : f32 , pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>LinearYawFromX &lt; T &gt; { } <span class="kw">impl </span>LinearYawFromX &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new (angle_diff : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ angle_diff , pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>LinearYawFromX &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new (angle_diff : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ angle_diff , pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; LinearYawFromX &lt; T &gt; { <span class="kw">pub fn </span>new (angle_diff : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ angle_diff , pose : T :: default () , } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>LinearYawFromX &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="kw">const </span>ANGLE_DIFF : f32 = <span class="number">7.0 </span>; <span class="self">Self </span>:: new (ANGLE_DIFF) } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>LinearYawFromX &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>LinearYawFromX &lt; &amp; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { linear_yaw_from_x (<span class="self">self </span>. pose . clone () , <span class="self">self </span>. angle_diff) } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>LinearYawFromX &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { linear_yaw_from_x (<span class="self">self </span>. pose . clone () , <span class="self">self </span>. angle_diff) } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>LinearYawFromX &lt; &amp; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { linear_yaw_from_x_stab1 (<span class="self">self </span>. pose . clone () , <span class="self">self </span>. angle_diff) } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>LinearYawFromX &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { linear_yaw_from_x_stab1 (<span class="self">self </span>. pose . clone () , <span class="self">self </span>. angle_diff) } } # [derive (Debug)] <span class="kw">pub struct </span>FlipYaw &lt; T &gt; { pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>FlipYaw &lt; T &gt; { } <span class="kw">impl </span>FlipYaw &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>FlipYaw &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; FlipYaw &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>FlipYaw &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>FlipYaw &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>FlipYaw &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { println ! (<span class="string">"YAW BEFORE: {:?}" </span>, <span class="self">self </span>. pose . target_yaw) ; <span class="kw">if let </span><span class="prelude-val">Some </span>(<span class="kw-2">ref mut </span>yaw) = <span class="self">self </span>. pose . target_yaw { <span class="kw">match </span>yaw { AdjustType :: Adjust (<span class="kw-2">ref mut </span>y) =&gt; * y = - * y , AdjustType :: Replace (<span class="kw-2">ref mut </span>y) =&gt; * y = - * y , } } ; println ! (<span class="string">"YAW AFTER: {:?}" </span>, <span class="self">self </span>. pose . target_yaw) ; <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>FlipYaw &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { println ! (<span class="string">"YAW BEFORE: {:?}" </span>, <span class="self">self </span>. pose . yaw_speed) ; <span class="kw">if let </span><span class="prelude-val">Some </span>(<span class="kw-2">ref mut </span>yaw) = <span class="self">self </span>. pose . yaw_speed { <span class="kw">match </span>yaw { AdjustType :: Adjust (<span class="kw-2">ref mut </span>y) =&gt; * y = - * y , AdjustType :: Replace (<span class="kw-2">ref mut </span>y) =&gt; * y = - * y , } } ; println ! (<span class="string">"YAW AFTER: {:?}" </span>, <span class="self">self </span>. pose . yaw_speed) ; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>StripY &lt; T &gt; { pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>StripY &lt; T &gt; { } <span class="kw">impl </span>StripY &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; StripY &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>StripY &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>StripY &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>StripY &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="self">self </span>. pose . y = <span class="prelude-val">None </span>; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>ConfidenceY &lt; T &gt; { pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>ConfidenceY &lt; T &gt; { } <span class="kw">impl </span>ConfidenceY &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; ConfidenceY &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>ConfidenceY &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>ConfidenceY &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>ConfidenceY &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="self">self </span>. pose . y = <span class="prelude-val">Some </span>(<span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (x)) = <span class="self">self </span>. pose . x { <span class="kw">if </span>x . is_zero () { AdjustType :: Replace (<span class="number">0.2</span>) } <span class="kw">else </span>{ AdjustType :: Adjust (<span class="number">0.1</span>) } } <span class="kw">else </span>{ AdjustType :: Replace (<span class="number">0.2</span>) }) ; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>SetY &lt; T &gt; { pose : T , y : AdjustType &lt; f32 &gt; , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>SetY &lt; T &gt; { } <span class="kw">impl </span>SetY &lt; Stability2Adjust &gt; { <span class="kw">pub const fn </span>new (y : AdjustType &lt; f32 &gt;) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : Stability2Adjust :: const_default () , y , } } } <span class="kw">impl </span>SetY &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new (y : AdjustType &lt; f32 &gt;) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , y , } } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>SetY &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>SetY &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="self">self </span>. pose . y = <span class="prelude-val">Some </span>(<span class="self">self </span>. y . clone ()) ; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>FlipX &lt; T &gt; { pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>FlipX &lt; T &gt; { } <span class="kw">impl </span>FlipX &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>FlipX &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; FlipX &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>FlipX &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>FlipX &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>FlipX &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(<span class="kw-2">ref mut </span>x) = <span class="self">self </span>. pose . x { * x = <span class="kw">match </span>* x { AdjustType :: Adjust (x) =&gt; AdjustType :: Adjust (- x) , AdjustType :: Replace (x) =&gt; AdjustType :: Replace (- x) , } ; } <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>FlipX &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(<span class="kw-2">ref mut </span>x) = <span class="self">self </span>. pose . x { * x = <span class="kw">match </span>* x { AdjustType :: Adjust (x) =&gt; AdjustType :: Adjust (- x) , AdjustType :: Replace (x) =&gt; AdjustType :: Replace (- x) , } ; } <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>StripX &lt; T &gt; { pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>StripX &lt; T &gt; { } <span class="kw">impl </span>StripX &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; StripX &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>StripX &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>StripX &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>StripX &lt; &amp; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">let </span><span class="kw-2">mut </span>pose = <span class="self">self </span>. pose . clone () ; pose . x = <span class="prelude-val">None </span>; pose } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>StripX &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="self">self </span>. pose . x = <span class="prelude-val">None </span>; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>FlatX &lt; T &gt; { pose : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>FlatX &lt; T &gt; { } <span class="kw">impl </span>FlatX &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>&lt; T : Default &gt; FlatX &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>FlatX &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>FlatX &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>FlatX &lt; &amp; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">let </span><span class="kw-2">mut </span>pose = <span class="self">self </span>. pose . clone () ; <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (val)) = <span class="self">self </span>. pose . x { pose . x = <span class="kw">if </span>val . is_zero () { <span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="number">0.0</span>)) } <span class="kw">else </span>{ <span class="prelude-val">Some </span>(AdjustType :: Replace (- <span class="number">0.3</span>)) } ; } ; pose } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>FlatX &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (val)) = <span class="self">self </span>. pose . x { <span class="self">self </span>. pose . x = <span class="kw">if </span>val . is_zero () { <span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="number">0.0</span>)) } <span class="kw">else </span>{ <span class="prelude-val">Some </span>(AdjustType :: Replace (- <span class="number">0.3</span>)) } ; } ; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>OffsetToPose &lt; T &gt; { offset : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>OffsetToPose &lt; T &gt; { } <span class="kw">impl </span>&lt; T &gt; OffsetToPose &lt; T &gt; { <span class="kw">pub const fn </span>new (offset : T) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ offset } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>OffsetToPose &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ offset : T :: default () , } } } <span class="kw">impl </span>&lt; T : Send + Sync + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>OffsetToPose &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. offset = input . clone () ; } } <span class="kw">impl </span>&lt; T : Send + Sync + Clone + Default &gt; ActionMod &lt; <span class="prelude-ty">Option </span>&lt; T &gt; &gt; <span class="kw">for </span>OffsetToPose &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; <span class="prelude-ty">Option </span>&lt; T &gt;) { <span class="kw">if let </span><span class="prelude-val">Some </span>(input) = input { <span class="self">self </span>. offset = input . clone () ; } <span class="kw">else </span>{ <span class="self">self </span>. offset = T :: default () ; } } } <span class="kw">impl </span>&lt; T : Send + Sync + Clone + Default &gt; ActionMod &lt; anyhow :: <span class="prelude-ty">Result </span>&lt; T &gt; &gt; <span class="kw">for </span>OffsetToPose &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; anyhow :: <span class="prelude-ty">Result </span>&lt; T &gt;) { <span class="kw">if let </span><span class="prelude-val">Ok </span>(input) = input { <span class="self">self </span>. offset = input . clone () ; } <span class="kw">else </span>{ <span class="self">self </span>. offset = T :: default () ; } } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>OffsetToPose &lt; Offset2D &lt; f64 &gt; &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">let </span><span class="kw-2">mut </span>adjust = Stability2Adjust :: default () ; adjust . set_x (AdjustType :: Replace (* <span class="self">self </span>. offset . x () <span class="kw">as </span>f32)) ; adjust . set_y (AdjustType :: Replace (* <span class="self">self </span>. offset . y () <span class="kw">as </span>f32)) ; adjust } } # [derive (Debug)] <span class="kw">pub struct </span>BoxToPose &lt; T &gt; { input : T , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>BoxToPose &lt; T &gt; { } <span class="kw">impl </span>&lt; T &gt; BoxToPose &lt; T &gt; { <span class="kw">pub const fn </span>new (input : T) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ input } } } <span class="kw">impl </span>&lt; T : Default &gt; Default <span class="kw">for </span>BoxToPose &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ input : T :: default () , } } } <span class="kw">impl </span>&lt; T : Send + Sync + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>BoxToPose &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. input = input . clone () ; } } <span class="kw">impl </span>&lt; T : Send + Sync + Clone + Default &gt; ActionMod &lt; <span class="prelude-ty">Option </span>&lt; T &gt; &gt; <span class="kw">for </span>BoxToPose &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; <span class="prelude-ty">Option </span>&lt; T &gt;) { <span class="kw">if let </span><span class="prelude-val">Some </span>(input) = input { <span class="self">self </span>. input = input . clone () ; } <span class="kw">else </span>{ <span class="self">self </span>. input = T :: default () ; } } } <span class="kw">impl </span>&lt; T : Send + Sync + Clone + Default &gt; ActionMod &lt; anyhow :: <span class="prelude-ty">Result </span>&lt; T &gt; &gt; <span class="kw">for </span>BoxToPose &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; anyhow :: <span class="prelude-ty">Result </span>&lt; T &gt;) { <span class="kw">if let </span><span class="prelude-val">Ok </span>(input) = input { <span class="self">self </span>. input = input . clone () ; } <span class="kw">else </span>{ <span class="self">self </span>. input = T :: default () ; } } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>BoxToPose &lt; DrawRect2d &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">let </span><span class="kw-2">mut </span>adjust = Stability2Adjust :: default () ; adjust . set_x (AdjustType :: Replace (<span class="self">self </span>. input . x <span class="kw">as </span>f32)) ; adjust . set_y (AdjustType :: Replace (((<span class="self">self </span>. input . width + <span class="self">self </span>. input . height) / <span class="number">2.0</span>) <span class="kw">as </span>f32 ,)) ; adjust } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>BoxToPose &lt; DrawRect2d &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">let </span><span class="kw-2">mut </span>adjust = Stability1Adjust :: default () ; adjust . set_x (AdjustType :: Replace (<span class="self">self </span>. input . x <span class="kw">as </span>f32)) ; adjust . set_y (AdjustType :: Replace (((<span class="self">self </span>. input . width + <span class="self">self </span>. input . height) / <span class="number">2.0</span>) <span class="kw">as </span>f32 ,)) ; adjust } } # [doc = <span class="string">" Modification for a stability assist 1 command"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" When values are None, they do not cause adjustments"</span>] # [derive (Debug , Clone , Default , Getters)] <span class="kw">pub struct </span>Stability1Adjust { x : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , y : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_pitch : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_roll : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , yaw_speed : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , target_depth : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; , } <span class="kw">impl </span>Stability1Adjust { <span class="kw">pub const fn </span>const_default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ x : <span class="prelude-val">None </span>, y : <span class="prelude-val">None </span>, target_pitch : <span class="prelude-val">None </span>, target_roll : <span class="prelude-val">None </span>, yaw_speed : <span class="prelude-val">None </span>, target_depth : <span class="prelude-val">None </span>, } } # [doc = <span class="string">" Convert all the invalid IEEE states into None"</span>] <span class="kw">fn </span>address_ieee (val : AdjustType &lt; f32 &gt;) -&gt; <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; { <span class="kw">match </span>val { AdjustType :: Replace (val) | AdjustType :: Adjust (val) <span class="kw">if </span>val . is_nan () | val . is_infinite () | val . is_subnormal () =&gt; { <span class="prelude-val">None </span>} val =&gt; <span class="prelude-val">Some </span>(val) , } } # [doc = <span class="string">" Bounds speeds to [-1, 1]"</span>] <span class="kw">fn </span>bound_speed (val : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; { <span class="kw">const </span>MIN_SPEED : f32 = - <span class="number">1.0 </span>; <span class="kw">const </span>MAX_SPEED : f32 = <span class="number">1.0 </span>; val . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; AdjustType :: Replace (clamp (val , MIN_SPEED , MAX_SPEED)) , AdjustType :: Adjust (val) =&gt; AdjustType :: Adjust (val) , }) } # [doc = <span class="string">" Bounds rotations to 360 degrees"</span>] <span class="kw">fn </span>bound_rot (val : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt; { <span class="kw">const </span>MAX_DEGREES : f32 = <span class="number">360.0 </span>; val . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; AdjustType :: Replace (val . rem (MAX_DEGREES)) , AdjustType :: Adjust (val) =&gt; AdjustType :: Adjust (val) , }) } <span class="kw">pub fn </span>set_x (&amp; <span class="kw-2">mut </span><span class="self">self </span>, x : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. x = <span class="self">Self </span>:: bound_speed (<span class="self">Self </span>:: address_ieee (x)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_y (&amp; <span class="kw-2">mut </span><span class="self">self </span>, y : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. y = <span class="self">Self </span>:: bound_speed (<span class="self">Self </span>:: address_ieee (y)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_pitch (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_pitch : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_pitch = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_pitch)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_roll (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_roll : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_roll = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_roll)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_yaw_speed (&amp; <span class="kw-2">mut </span><span class="self">self </span>, yaw_speed : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. yaw_speed = <span class="self">Self </span>:: bound_speed (<span class="self">Self </span>:: address_ieee (yaw_speed)) ; <span class="self">self </span>} <span class="kw">pub fn </span>set_target_depth (&amp; <span class="kw-2">mut </span><span class="self">self </span>, target_depth : AdjustType &lt; f32 &gt;) -&gt; &amp; <span class="self">Self </span>{ <span class="self">self </span>. target_depth = <span class="self">Self </span>:: bound_rot (<span class="self">Self </span>:: address_ieee (target_depth)) ; <span class="self">self </span>} } # [doc = <span class="string">" Stores the command to send to stability assist 2"</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" If yaw_speed is None, it is set to the current yaw on first execution"</span>] # [derive (Debug , Clone)] <span class="kw">pub struct </span>Stability1Pos { x : f32 , y : f32 , target_pitch : f32 , target_roll : f32 , yaw_speed : f32 , target_depth : f32 , } <span class="kw">impl </span>Stability1Pos { <span class="kw">pub const fn </span>new (x : f32 , y : f32 , target_pitch : f32 , target_roll : f32 , yaw_speed : f32 , target_depth : f32 ,) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ x , y , target_pitch , target_roll , yaw_speed , target_depth , } } # [doc = <span class="string">" Executes the position in stability assist"</span>] <span class="kw">pub async fn </span>exec (&amp; <span class="kw-2">mut </span><span class="self">self </span>, board : &amp; ControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt;) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { println ! (<span class="string">"Stability 1 speed set: {:#?}" </span>, <span class="self">self</span>) ; board . stability_1_speed_set (<span class="self">self </span>. x , <span class="self">self </span>. y , <span class="self">self </span>. target_pitch , <span class="self">self </span>. target_roll , <span class="self">self </span>. yaw_speed , <span class="self">self </span>. target_depth ,) . <span class="kw">await </span>} # [doc = <span class="string">" Sets speed, bounded to [-1, 1]"</span>] <span class="kw">fn </span>set_speed (base : f32 , adjuster : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; f32 { <span class="kw">const </span>MIN_SPEED : f32 = - <span class="number">1.0 </span>; <span class="kw">const </span>MAX_SPEED : f32 = <span class="number">1.0 </span>; adjuster . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; val , AdjustType :: Adjust (val) =&gt; clamp (base + val , MIN_SPEED , MAX_SPEED) , }) . unwrap_or (base) } # [doc = <span class="string">" Set rotation, bounded to 360 degrees"</span>] <span class="kw">fn </span>set_rot (base : f32 , adjuster : <span class="prelude-ty">Option </span>&lt; AdjustType &lt; f32 &gt; &gt;) -&gt; f32 { <span class="kw">const </span>MAX_DEGREES : f32 = <span class="number">360.0 </span>; adjuster . map (| val | <span class="kw">match </span>val { AdjustType :: Replace (val) =&gt; val , AdjustType :: Adjust (val) =&gt; (val + base) . rem (MAX_DEGREES) , }) . unwrap_or (base) } # [doc = <span class="string">" Adjusts the position according to `adjuster`."</span>] # [doc = <span class="string">""</span>] # [doc = <span class="string">" The x and y fields are bounded to [-1, 1]."</span>] # [doc = <span class="string">" The pitch, roll, yaw, depth fields wrap around 360 degrees."</span>] <span class="kw">pub fn </span>adjust (&amp; <span class="kw-2">mut </span><span class="self">self </span>, adjuster : &amp; Stability1Adjust) -&gt; &amp; <span class="self">Self </span>{ println ! (<span class="string">"Stability 2 pre-adjust: {:#?}" </span>, <span class="self">self</span>) ; println ! (<span class="string">"Adjuster: {:#?}" </span>, adjuster) ; <span class="self">self </span>. x = <span class="self">Self </span>:: set_speed (<span class="self">self </span>. x , adjuster . x () . clone ()) ; <span class="self">self </span>. y = <span class="self">Self </span>:: set_speed (<span class="self">self </span>. y , adjuster . y () . clone ()) ; <span class="self">self </span>. target_pitch = <span class="self">Self </span>:: set_rot (<span class="self">self </span>. target_pitch , adjuster . target_pitch () . clone ()) ; <span class="self">self </span>. target_roll = <span class="self">Self </span>:: set_rot (<span class="self">self </span>. target_roll , adjuster . target_roll () . clone ()) ; <span class="self">self </span>. target_depth = <span class="self">Self </span>:: set_rot (<span class="self">self </span>. target_depth , adjuster . target_depth () . clone ()) ; <span class="self">self </span>. yaw_speed = <span class="self">Self </span>:: set_speed (<span class="self">self </span>. yaw_speed , adjuster . yaw_speed () . clone ()) ; println ! (<span class="string">"Stability 1 post-adjust: {:#?}" </span>, <span class="self">self</span>) ; <span class="self">self </span>} <span class="kw">pub const fn </span>const_default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new (<span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0 </span>, <span class="number">0.0</span>) } } <span class="kw">impl </span>Default <span class="kw">for </span>Stability1Pos { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: const_default () } } # [derive (Debug)] <span class="kw">pub struct </span>Stability1Movement &lt; <span class="lifetime">'a </span>, T &gt; { context : &amp; <span class="lifetime">'a </span>T , pose : Stability1Pos , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>Stability1Movement &lt; <span class="lifetime">'_ </span>, T &gt; { } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T &gt; Stability1Movement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">pub const fn </span>new (context : &amp; <span class="lifetime">'a </span>T , pose : Stability1Pos) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , pose } } <span class="kw">pub fn </span>uninitialized (context : &amp; <span class="lifetime">'a </span>T) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ context , pose : Stability1Pos :: default () , } } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; Stability1Pos &gt; <span class="kw">for </span>Stability1Movement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; Stability1Pos) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>&lt; T &gt; ActionMod &lt; Stability1Adjust &gt; <span class="kw">for </span>Stability1Movement &lt; <span class="lifetime">'_ </span>, T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; Stability1Adjust) { <span class="self">self </span>. pose . adjust (input) ; } } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; <span class="prelude-ty">Result </span>&lt; () &gt; &gt; <span class="kw">for </span>Stability1Movement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result </span>&lt; () &gt; { <span class="self">self </span>. pose . exec (<span class="self">self </span>. context . get_control_board ()) . <span class="kw">await </span>} } <span class="kw">impl </span>&lt; <span class="lifetime">'a </span>, T : GetControlBoard &lt; WriteHalf &lt; SerialStream &gt; &gt; &gt; ActionExec &lt; () &gt; <span class="kw">for </span>Stability1Movement &lt; <span class="lifetime">'a </span>, T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) { <span class="kw">let _ </span>= <span class="self">self </span>. pose . exec (<span class="self">self </span>. context . get_control_board ()) . <span class="kw">await </span>; } } <span class="kw">impl </span>StripY &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>StripY &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="self">self </span>. pose . y = <span class="prelude-val">None </span>; <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>StripX &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>StripX &lt; &amp; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">let </span><span class="kw-2">mut </span>pose = <span class="self">self </span>. pose . clone () ; pose . x = <span class="prelude-val">None </span>; pose } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>StripX &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="self">self </span>. pose . x = <span class="prelude-val">None </span>; <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>FlatX &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , } } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>FlatX &lt; &amp; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">let </span><span class="kw-2">mut </span>pose = <span class="self">self </span>. pose . clone () ; println ! (<span class="string">"Before transform: {:#?}" </span>, pose) ; <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (val)) = <span class="self">self </span>. pose . x { pose . x = <span class="kw">if </span>val . is_zero () { <span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="number">0.0</span>)) } <span class="kw">else </span>{ <span class="prelude-val">Some </span>(AdjustType :: Replace (- <span class="number">0.3</span>)) } ; } ; pose } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>FlatX &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { println ! (<span class="string">"Before transform: {:#?}" </span>, <span class="self">self </span>. pose) ; <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (val)) = <span class="self">self </span>. pose . x { <span class="self">self </span>. pose . x = <span class="kw">if </span>val . is_zero () { <span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="number">0.0</span>)) } <span class="kw">else </span>{ <span class="prelude-val">Some </span>(AdjustType :: Replace (- <span class="number">0.3</span>)) } ; } ; <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>OffsetToPose &lt; Offset2D &lt; f64 &gt; &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">let </span><span class="kw-2">mut </span>adjust = Stability1Adjust :: default () ; adjust . set_x (AdjustType :: Replace (* <span class="self">self </span>. offset . x () <span class="kw">as </span>f32)) ; adjust . set_y (AdjustType :: Replace (* <span class="self">self </span>. offset . y () <span class="kw">as </span>f32)) ; adjust } } # [derive (Debug)] <span class="kw">pub struct </span>DefaultGen &lt; T &gt; { _phantom : PhantomData &lt; T &gt; , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>DefaultGen &lt; T &gt; { } <span class="kw">impl </span>&lt; T &gt; DefaultGen &lt; T &gt; { <span class="kw">pub fn </span>new () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ _phantom : PhantomData , } } } <span class="kw">impl </span>&lt; T &gt; Default <span class="kw">for </span>DefaultGen &lt; T &gt; { <span class="kw">fn </span>default () -&gt; <span class="self">Self </span>{ <span class="self">Self </span>:: new () } } <span class="kw">impl </span>&lt; T , U : Send + Sync &gt; ActionMod &lt; U &gt; <span class="kw">for </span>DefaultGen &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, _input : &amp; U) { } } <span class="kw">impl </span>&lt; T : Default + Send + Sync &gt; ActionExec &lt; T &gt; <span class="kw">for </span>DefaultGen &lt; T &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; T { T :: default () } } # [derive (Debug)] <span class="kw">pub struct </span>CautiousConstantX &lt; T &gt; { pose : T , speed : f32 , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>CautiousConstantX &lt; T &gt; { } <span class="kw">impl </span>CautiousConstantX &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new (speed : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , speed , } } } <span class="kw">impl </span>CautiousConstantX &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new (speed : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , speed , } } } <span class="kw">impl </span>&lt; T : Default &gt; CautiousConstantX &lt; T &gt; { <span class="kw">pub fn </span>new (speed : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () , speed , } } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>CautiousConstantX &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>CautiousConstantX &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="kw-2">ref mut </span>x)) = <span class="self">self </span>. pose . x { * x = <span class="kw">if </span>x . abs () &lt; <span class="number">0.5 </span>&amp;&amp; x . signum () == <span class="self">self </span>. speed . signum () { <span class="self">self </span>. speed } <span class="kw">else </span>{ <span class="number">0.0 </span>} ; } ; <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>CautiousConstantX &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="kw-2">ref mut </span>x)) = <span class="self">self </span>. pose . x { * x = <span class="kw">if </span>! x . is_zero () &amp;&amp; x . signum () == <span class="self">self </span>. speed . signum () { <span class="number">0.2 </span>} <span class="kw">else </span>{ <span class="number">0.0 </span>} ; } ; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>MinYaw &lt; T &gt; { pose : T , speed : f32 , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>MinYaw &lt; T &gt; { } <span class="kw">impl </span>MinYaw &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new (speed : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , speed , } } } <span class="kw">impl </span>MinYaw &lt; &amp; Stability1Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability1Adjust = Stability1Adjust :: const_default () ; <span class="kw">pub const fn </span>new (speed : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , speed , } } } <span class="kw">impl </span>&lt; T : Default &gt; MinYaw &lt; T &gt; { <span class="kw">pub fn </span>new (speed : f32) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : T :: default () , speed , } } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>MinYaw &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>MinYaw &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Adjust (<span class="kw-2">ref mut </span>x)) = <span class="self">self </span>. pose . target_yaw { <span class="kw">if </span>x . is_zero () { println ! (<span class="string">"ZERO, SETTING MIN SPEED"</span>) ; * x = <span class="self">self </span>. speed ; } } ; <span class="self">self </span>. pose . clone () } } <span class="kw">impl </span>ActionExec &lt; Stability1Adjust &gt; <span class="kw">for </span>MinYaw &lt; Stability1Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability1Adjust { <span class="kw">if let </span><span class="prelude-val">Some </span>(AdjustType :: Replace (<span class="kw-2">ref mut </span>x)) = <span class="self">self </span>. pose . yaw_speed { <span class="kw">if </span>x . is_zero () { * x = <span class="self">self </span>. speed ; } } ; <span class="self">self </span>. pose . clone () } } # [derive (Debug)] <span class="kw">pub struct </span>SetX &lt; T &gt; { pose : T , x : AdjustType &lt; f32 &gt; , } <span class="kw">impl </span>&lt; T &gt; Action <span class="kw">for </span>SetX &lt; T &gt; { } <span class="kw">impl </span>SetX &lt; Stability2Adjust &gt; { <span class="kw">pub const fn </span>new (x : AdjustType &lt; f32 &gt;) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : Stability2Adjust :: const_default () , x , } } } <span class="kw">impl </span>SetX &lt; &amp; Stability2Adjust &gt; { <span class="kw">const </span>DEFAULT_POSE : Stability2Adjust = Stability2Adjust :: const_default () ; <span class="kw">pub const fn </span>new (x : AdjustType &lt; f32 &gt;) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>{ pose : &amp; <span class="self">Self </span>:: DEFAULT_POSE , x , } } } <span class="kw">impl </span>&lt; T : Sync + Send + Clone &gt; ActionMod &lt; T &gt; <span class="kw">for </span>SetX &lt; T &gt; { <span class="kw">fn </span>modify (&amp; <span class="kw-2">mut </span><span class="self">self </span>, input : &amp; T) { <span class="self">self </span>. pose = input . clone () ; } } <span class="kw">impl </span>ActionExec &lt; Stability2Adjust &gt; <span class="kw">for </span>SetX &lt; Stability2Adjust &gt; { <span class="kw">async fn </span>execute (&amp; <span class="kw-2">mut </span><span class="self">self</span>) -&gt; Stability2Adjust { <span class="self">self </span>. pose . x = <span class="prelude-val">Some </span>(<span class="self">self </span>. x . clone ()) ; <span class="self">self </span>. pose . clone () } } <span class="kw">pub fn </span>graph_actions&lt;T: GraphActionContext::GetMainElectronicsBoard + GraphActionContext::GetControlBoard&lt;tokio::io::WriteHalf&lt;tokio_serial::SerialStream&gt;&gt; + GraphActionContext::GetFrontCamMat + Send + Sync + std::marker::Unpin&gt;(context: <span class="kw-2">&amp;</span><span class="lifetime">'static </span>T) -&gt; Vec&lt;(String, Box&lt;<span class="kw">dyn </span>GraphAction + <span class="lifetime">'_</span>&gt;)&gt; { <span class="macro">vec!</span>[]}</code></pre></div></section></main></body></html>