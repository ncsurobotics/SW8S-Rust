<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The half-lock structure"><title>signal_hook_registry::half_lock - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-dd39b87e5fcfba68.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="signal_hook_registry" data-themes="" data-resource-suffix="" data-rustdoc-version="1.80.0 (051478957 2024-07-21)" data-channel="1.80.0" data-search-js="search-d52510db62a78183.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../signal_hook_registry/index.html">signal_hook_registry</a><span class="version">1.4.1</span></h2></div><h2 class="location"><a href="#">Module half_lock</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li></ul></section><h2><a href="../index.html">In crate signal_hook_registry</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">signal_hook_registry</a>::<wbr><a class="mod" href="#">half_lock</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../src/signal_hook_registry/half_lock.rs.html#1-232">source</a> Â· <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>The half-lock structure</p>
<p>We need a way to protect the structure with configured hooks â€’ a signal may happen in arbitrary
thread and needs to read them while another thread might be manipulating the structure.</p>
<p>Under ordinary circumstances we would be happy to just use <code>Mutex&lt;HashMap&lt;c_int, _&gt;&gt;</code>. However,
as we use it in the signal handler, we are severely limited in what we can or canâ€™t use. So we
choose to implement kind of spin-look thing with atomics.</p>
<p>In the reader it is always simply locked and then unlocked, making sure it doesnâ€™t disappear
while in use.</p>
<p>The writer has a separate mutex (that prevents other writers; this is used outside of the
signal handler), makes a copy of the data and swaps an atomic pointer to the data structure.
But it waits until everything is unlocked (no signal handler has the old data) for dropping the
old instance. Thereâ€™s a generation trick to make sure that new signal locks another instance.</p>
<p>The downside is, this is an active spin lock at the writer end. However, we assume than:</p>
<ul>
<li>Signals are one time setup before we actually have threads. We just need to make <em>sure</em> we
are safe even if this is not true.</li>
<li>Signals are rare, happening at the same time as the write even rarer.</li>
<li>Signals are short, as there is mostly nothing allowed inside them anyway.</li>
<li>Our tool box is severely limited.</li>
</ul>
<p>Therefore this is hopefully reasonable trade-off.</p>
<h2 id="atomic-orderings"><a class="doc-anchor" href="#atomic-orderings">Â§</a>Atomic orderings</h2>
<p>The whole code uses SeqCst conservatively. Atomics are not used because of performance here and
are the minor price around signals anyway. But the comments state which orderings should be
enough in practice in case someone wants to get inspired (but do make your own check through
them anyway).</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.HalfLock.html" title="struct signal_hook_registry::half_lock::HalfLock">HalfLock</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.ReadGuard.html" title="struct signal_hook_registry::half_lock::ReadGuard">ReadGuard</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.WriteGuard.html" title="struct signal_hook_registry::half_lock::WriteGuard">WriteGuard</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li></ul><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.MAX_GUARDS.html" title="constant signal_hook_registry::half_lock::MAX_GUARDS">MAX_GUARDS</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.YIELD_EVERY.html" title="constant signal_hook_registry::half_lock::YIELD_EVERY">YIELD_EVERY</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li></ul></section></div></main></body></html>